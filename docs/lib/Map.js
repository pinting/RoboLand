"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const GroundCell_1 = require("./Element/Cell/GroundCell");
const Coord_1 = require("./Coord");
const Utils_1 = require("./Utils");
const CellFactory_1 = require("./Element/Cell/CellFactory");
const CellType_1 = require("./Element/Cell/CellType");
const BasicRobot_1 = require("./Element/Robot/BasicRobot");
class Map {
    constructor() {
        this.robotCount = 2;
        this.OnUpdate = Utils_1.Utils.Noop;
    }
    static GetInstance() {
        if (Map.instance == undefined) {
            return Map.instance = new Map();
        }
        return Map.instance;
    }
    Init(size) {
        this.size = size;
        this.robots = [];
        this.cells = [];
        for (var i = 0; i < size * size; i++) {
            let x = i % size;
            let y = Math.floor(i / size);
            this.cells[i] = new GroundCell_1.GroundCell(new Coord_1.Coord(x, y));
        }
        this.robots.push(new BasicRobot_1.BasicRobot(new Coord_1.Coord(Utils_1.Utils.Random(0, size - 1), 0)));
        this.robots.push(new BasicRobot_1.BasicRobot(new Coord_1.Coord(Utils_1.Utils.Random(0, size - 1), size - 1)));
        this.OnUpdate();
    }
    Load(url) {
        return __awaiter(this, void 0, void 0, function* () {
            var raw;
            try {
                raw = JSON.parse(yield Utils_1.Utils.Get(url));
                if (raw == null && raw.length < 2 && raw.length != Math.pow(raw[0], 2) + 1) {
                    return;
                }
            }
            catch (e) {
                return;
            }
            this.cells = [];
            this.robots = [];
            this.size = raw.shift();
            var robotSpots = new Array();
            var robotCount = 0;
            for (let i = 0; i < raw.length; i++) {
                let x = i % this.size;
                let y = Math.floor(i / this.size);
                let type = raw[i];
                this.cells[i] = CellFactory_1.CellFactory.FromType(type, new Coord_1.Coord(x, y));
                if (robotCount < this.robotCount && type == CellType_1.CellType.Ground) {
                    if (Utils_1.Utils.Random(0, 20) == 1) {
                        this.robots.push(new BasicRobot_1.BasicRobot(new Coord_1.Coord(x, y)));
                        robotCount++;
                    }
                    else {
                        robotSpots.push(new Coord_1.Coord(x, y));
                    }
                }
            }
            for (; robotSpots.length > 0 && robotCount < this.robotCount; robotCount++) {
                let coord = robotSpots.splice(Utils_1.Utils.Random(0, robotSpots.length - 1), 1)[0];
                let robot = new BasicRobot_1.BasicRobot(coord);
                this.robots.push(robot);
            }
            this.OnUpdate();
        });
    }
    GetElement(form, coord) {
        var result = null;
        form.some(e => {
            if (e.GetPosition().Is(coord)) {
                result = e;
                return true;
            }
        });
        return result;
    }
    GetCell(coord) {
        return this.GetElement(this.cells, coord);
    }
    GetRobot(coord) {
        return this.GetElement(this.robots, coord);
    }
    RemoveRobot(robot) {
        var index = this.robots.indexOf(robot);
        if (index >= 0) {
            this.robots.splice(index, 1);
        }
    }
    GetSize() {
        return this.size;
    }
    GetCells() {
        return this.cells;
    }
    GetRobots() {
        return this.robots;
    }
    GetElements() {
        return this.cells.concat(this.robots);
    }
}
exports.Map = Map;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdkMsRUFBRSxDQUFBLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUNkLENBQUM7WUFDRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakMsQ0FBQztJQUNMLENBQUM7SUFLTSxPQUFPO1FBRVYsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUtNLFFBQVE7UUFFWCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBS00sU0FBUztRQUVaLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFLTSxXQUFXO1FBRWQsTUFBTSxDQUFjLElBQUksQ0FBQyxLQUFNLENBQUMsTUFBTSxDQUFhLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwRSxDQUFDO0NBTUo7QUF0TkQsa0JBc05DIiwiZmlsZSI6Ind3dy9saWIvTWFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUNlbGwgfSBmcm9tIFwiLi9FbGVtZW50L0NlbGwvSUNlbGxcIjtcclxuaW1wb3J0IHsgR3JvdW5kQ2VsbCB9IGZyb20gXCIuL0VsZW1lbnQvQ2VsbC9Hcm91bmRDZWxsXCI7XHJcbmltcG9ydCB7IENvb3JkIH0gZnJvbSBcIi4vQ29vcmRcIjtcclxuaW1wb3J0IHsgSVJvYm90IH0gZnJvbSBcIi4vRWxlbWVudC9Sb2JvdC9JUm9ib3RcIjtcclxuaW1wb3J0IHsgSUVsZW1lbnQgfSBmcm9tIFwiLi9FbGVtZW50L0lFbGVtZW50XCI7XHJcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSBcIi4vVXRpbHNcIjtcclxuaW1wb3J0IHsgQ2VsbEZhY3RvcnkgfSBmcm9tIFwiLi9FbGVtZW50L0NlbGwvQ2VsbEZhY3RvcnlcIjtcclxuaW1wb3J0IHsgQ2VsbFR5cGUgfSBmcm9tIFwiLi9FbGVtZW50L0NlbGwvQ2VsbFR5cGVcIjtcclxuaW1wb3J0IHsgQmFzaWNSb2JvdCB9IGZyb20gXCIuL0VsZW1lbnQvUm9ib3QvQmFzaWNSb2JvdFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIE1hcFxyXG57XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJvYm90Q291bnQ6IG51bWJlciA9IDI7XHJcblxyXG4gICAgcHJpdmF0ZSByb2JvdHM6IEFycmF5PElSb2JvdD47XHJcbiAgICBwcml2YXRlIGNlbGxzOiBBcnJheTxJQ2VsbD47XHJcblxyXG4gICAgcHJpdmF0ZSBzaXplOiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhlIGNsYXNzLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogTWFwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IHRoZSBzaW5nbGV0b24gaW5zdGFuY2UuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgR2V0SW5zdGFuY2UoKTogTWFwXHJcbiAgICB7XHJcbiAgICAgICAgaWYoTWFwLmluc3RhbmNlID09IHVuZGVmaW5lZClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybiBNYXAuaW5zdGFuY2UgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gTWFwLmluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ29uc3RydWN0IGEgc2ltcGxlIG5ldyBtYXAuIFxyXG4gICAgICogQHBhcmFtIHNpemUgU2l6ZSBvZiB0aGUgbWFwLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgSW5pdChzaXplOiBudW1iZXIpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTtcclxuICAgICAgICB0aGlzLnJvYm90cyA9IFtdO1xyXG4gICAgICAgIHRoaXMuY2VsbHMgPSBbXTtcclxuXHJcbiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHNpemUgKiBzaXplOyBpKyspXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsZXQgeCA9IGkgJSBzaXplO1xyXG4gICAgICAgICAgICBsZXQgeSA9IE1hdGguZmxvb3IoaSAvIHNpemUpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jZWxsc1tpXSA9IG5ldyBHcm91bmRDZWxsKG5ldyBDb29yZCh4LCB5KSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJvYm90cy5wdXNoKG5ldyBCYXNpY1JvYm90KG5ldyBDb29yZChVdGlscy5SYW5kb20oMCwgc2l6ZSAtIDEpLCAwKSkpO1xyXG4gICAgICAgIHRoaXMucm9ib3RzLnB1c2gobmV3IEJhc2ljUm9ib3QobmV3IENvb3JkKFV0aWxzLlJhbmRvbSgwLCBzaXplIC0gMSksIHNpemUgLSAxKSkpO1xyXG5cclxuICAgICAgICB0aGlzLk9uVXBkYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMb2FkIGEgbWFwIGZyb20gYW4gZXh0ZXJuYWwgZmlsZS4gVGhlIEpTT04gbmVlZHMgdG8gY29udGFpbiBhbiBhcnJheSBvZiBudW1iZXJzLlxyXG4gICAgICogVGhlIGZpcnN0IG51bWJlciB3aWxsIGRldGVybWluYXRlIHRoZSBzaXplIG9mIHRoZSBtYXAsIHdoaWxlIHRoZSBvdGhlcnMgd2lsbFxyXG4gICAgICogdGVsbCB0aGUgaW50ZXJwcmV0ZXIgdHlwZSBvZiB0aGUgY2VsbCBiYXNlZCBvbiB0aGUgQ2VsbFR5cGUgZW51bS5cclxuICAgICAqIEBwYXJhbSB1cmwgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBMb2FkKHVybDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPlxyXG4gICAge1xyXG4gICAgICAgIHZhciByYXc6IEFycmF5PG51bWJlcj47XHJcblxyXG4gICAgICAgIHRyeVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmF3ID0gSlNPTi5wYXJzZShhd2FpdCBVdGlscy5HZXQodXJsKSk7XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBpdCBpcyBhIHZhbGlkIG1hcCBhcnJheVxyXG4gICAgICAgICAgICBpZihyYXcgPT0gbnVsbCAmJiByYXcubGVuZ3RoIDwgMiAmJiByYXcubGVuZ3RoICE9IE1hdGgucG93KHJhd1swXSwgMikgKyAxKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2goZSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuY2VsbHMgPSBbXTtcclxuICAgICAgICB0aGlzLnJvYm90cyA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2l6ZSA9IHJhdy5zaGlmdCgpOyAvLyBGaXJzdCBlbGVtZW50IGlzIHRoZSBzaXplXHJcblxyXG4gICAgICAgIHZhciByb2JvdFNwb3RzID0gbmV3IEFycmF5PENvb3JkPigpO1xyXG4gICAgICAgIHZhciByb2JvdENvdW50ID0gMDtcclxuXHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHJhdy5sZW5ndGg7IGkrKylcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCB4ID0gaSAlIHRoaXMuc2l6ZTtcclxuICAgICAgICAgICAgbGV0IHkgPSBNYXRoLmZsb29yKGkgLyB0aGlzLnNpemUpO1xyXG5cclxuICAgICAgICAgICAgbGV0IHR5cGU6IENlbGxUeXBlID0gcmF3W2ldO1xyXG5cclxuICAgICAgICAgICAgLy8gQ3JlYXRlIGNlbGwgYmFzZWQgb24gdGhlIENlbGxUeXBlXHJcbiAgICAgICAgICAgIHRoaXMuY2VsbHNbaV0gPSBDZWxsRmFjdG9yeS5Gcm9tVHlwZSh0eXBlLCBuZXcgQ29vcmQoeCwgeSkpO1xyXG5cclxuICAgICAgICAgICAgLy8gSWYgdGhlIGNlbGwgaXMgZ3JvdW5kIGFuZCB0aGVyZSBpcyAwIG9yIDEgcm9ib3QsIHRyeSB0byBhZGQgb25lXHJcbiAgICAgICAgICAgIGlmKHJvYm90Q291bnQgPCB0aGlzLnJvYm90Q291bnQgJiYgdHlwZSA9PSBDZWxsVHlwZS5Hcm91bmQpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIC8vIEdpdmUgdGhlIGNlbGwgNSUgY2hhbmNlXHJcbiAgICAgICAgICAgICAgICBpZihVdGlscy5SYW5kb20oMCwgMjApID09IDEpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIGEgbmV3IHJvYm90IGFuZCBpbmNyZW1lbnQgcm9ib3QgY291bnRcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJvYm90cy5wdXNoKG5ldyBCYXNpY1JvYm90KG5ldyBDb29yZCh4LCB5KSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJvYm90Q291bnQrKztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgY2VsbCBsb3N0LCBzYXZlIGl0IGZvciBsYXRlclxyXG4gICAgICAgICAgICAgICAgICAgIHJvYm90U3BvdHMucHVzaChuZXcgQ29vcmQoeCwgeSkpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIElmIHRoZSBtYXAgaXMgbG9hZGVkLCBidXQgdG9vIGZldyByb2JvdHMgd2VyZSBhZGRlZCwgYWRkIG5ldyBvbmVzXHJcbiAgICAgICAgLy8gYmFzZWQgb24gdGhlIFtzYXZlIGlmIGZvciBsYXRlcl0gc3BvdHNcclxuICAgICAgICBmb3IoOyByb2JvdFNwb3RzLmxlbmd0aCA+IDAgJiYgcm9ib3RDb3VudCA8IHRoaXMucm9ib3RDb3VudDsgcm9ib3RDb3VudCsrKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbGV0IGNvb3JkID0gcm9ib3RTcG90cy5zcGxpY2UoVXRpbHMuUmFuZG9tKDAsIHJvYm90U3BvdHMubGVuZ3RoIC0gMSksIDEpWzBdO1xyXG4gICAgICAgICAgICBsZXQgcm9ib3QgPSBuZXcgQmFzaWNSb2JvdChjb29yZCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJvYm90cy5wdXNoKHJvYm90KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuT25VcGRhdGUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhbiBlbGVtZW50IGZyb20gdGhlIGdpdmVuIGFycmF5IGJ5IGNvb3JkLlxyXG4gICAgICogQHBhcmFtIGZvcm1cclxuICAgICAqIEBwYXJhbSBjb29yZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIEdldEVsZW1lbnQoZm9ybTogSUVsZW1lbnRbXSwgY29vcmQ6IENvb3JkKTogSUVsZW1lbnRcclxuICAgIHtcclxuICAgICAgICB2YXIgcmVzdWx0OiBJRWxlbWVudCA9IG51bGw7XHJcblxyXG4gICAgICAgIGZvcm0uc29tZShlID0+IFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgaWYoZS5HZXRQb3NpdGlvbigpLklzKGNvb3JkKSkgXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGU7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhIGNlbGwgYnkgY29vcmQuXHJcbiAgICAgKiBAcGFyYW0gY29vcmQgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBHZXRDZWxsKGNvb3JkOiBDb29yZCk6IElDZWxsXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIDxJQ2VsbD50aGlzLkdldEVsZW1lbnQodGhpcy5jZWxscywgY29vcmQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGEgcm9ib3QgYnkgY29vcmQuXHJcbiAgICAgKiBAcGFyYW0gY29vcmQgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBHZXRSb2JvdChjb29yZDogQ29vcmQpOiBJUm9ib3RcclxuICAgIHtcclxuICAgICAgICByZXR1cm4gPElSb2JvdD50aGlzLkdldEVsZW1lbnQodGhpcy5yb2JvdHMsIGNvb3JkKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhIHJvYm90IGZyb20gdGhlIGxpc3QuXHJcbiAgICAgKiBAcGFyYW0gcm9ib3QgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBSZW1vdmVSb2JvdChyb2JvdDogSVJvYm90KVxyXG4gICAge1xyXG4gICAgICAgIHZhciBpbmRleCA9IHRoaXMucm9ib3RzLmluZGV4T2Yocm9ib3QpO1xyXG5cclxuICAgICAgICBpZihpbmRleCA+PSAwKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5yb2JvdHMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXQgdGhlIHNpemUgb2YgdGhlIG1hcC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIEdldFNpemUoKTogbnVtYmVyXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2l6ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCB0aGUgY2VsbHMgb2YgdGhlIG1hcC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIEdldENlbGxzKCk6IEFycmF5PElDZWxsPlxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNlbGxzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IHRoZSByb2JvdHMgb2YgdGhlIG1hcC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIEdldFJvYm90cygpOiBBcnJheTxJUm9ib3Q+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucm9ib3RzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJuIGVsZW1lbnRzIG9mIHRoZSBtYXAgKHJvYm90cyBhbmQgY2VsbHMpLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgR2V0RWxlbWVudHMoKTogQXJyYXk8SUVsZW1lbnQ+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuICg8SUVsZW1lbnRbXT50aGlzLmNlbGxzKS5jb25jYXQoPElFbGVtZW50W10+dGhpcy5yb2JvdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2FsbGVkIHdoZW4gdGhlIG1hcCB3YXMgdXBkYXRlZC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIE9uVXBkYXRlOiAoKSA9PiB2b2lkID0gVXRpbHMuTm9vcDtcclxufSJdfQ==
