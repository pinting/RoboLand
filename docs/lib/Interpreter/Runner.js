"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Adapter_1 = require("./Adapter");
const Processor_1 = require("./Processor");
const Parser_1 = require("./Parser");
class Runner {
    constructor(robot) {
        this.speed = 300;
        this.adapter = new Adapter_1.Adapter(robot);
        this.processor = new Processor_1.Processor;
        this.parser = new Parser_1.Parser;
    }
    Run(code) {
        this.Stop();
        this.parser.Parse(code);
        this.processor.Context = {
            move: this.adapter.move.bind(this.adapter),
            test: this.adapter.test.bind(this.adapter),
            attack: this.adapter.attack.bind(this.adapter)
        };
        this.counter = 0;
        this.interval = setInterval(() => this.ExecuteLine(), this.speed);
    }
    Stop() {
        if (this.interval) {
            clearInterval(this.interval);
        }
    }
    ExecuteLine() {
        if (this.counter < 0 && this.counter >= this.parser.Code.length) {
            this.Stop();
            return;
        }
        let line = this.parser.Code[this.counter++];
        try {
            switch (line[0]) {
                case "LABEL":
                    break;
                case "GOTO":
                    this.ExecuteGoto(line);
                    break;
                case "CALL":
                    this.ExecuteCall(line);
                    break;
                case "SET":
                    this.ExecuteSet(line);
                    break;
            }
        }
        catch (e) {
            this.Stop();
        }
    }
    ExecuteGoto(parameters) {
        const set = () => this.counter = this.parser.Labels.hasOwnProperty(parameters[1]) ? this.parser.Labels[parameters[1]] : -1;
        if (parameters.length == 2) {
            set();
        }
        else if (parameters.length >= 4) {
            let condition = parameters.slice(3).join(" ");
            if (this.processor.Solve(condition) != 0)
                set();
        }
        else {
            throw new Error("Invalid GOTO");
        }
    }
    ExecuteCall(parameters) {
        if (parameters.length < 2) {
            throw new Error("Invalid CALL");
        }
        let call = parameters.slice(1).join(" ");
        this.processor.Solve(call);
    }
    ExecuteSet(parameters) {
        if (parameters.length < 3) {
            throw new Error("Invalid SET");
        }
        let call = parameters.slice(2).join(" ");
        this.processor.Context[parameters[1]] = this.processor.Solve(call);
    }
}
exports.Runner = Runner;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93d3cvbGliL0ludGVycHJldGVyL1J1bm5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFvQztBQUNwQywyQ0FBd0M7QUFFeEMscUNBQWtDO0FBRWxDO0lBYUksWUFBbUIsS0FBYTtRQVhmLFVBQUssR0FBVyxHQUFHLENBQUM7UUFhakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLHFCQUFTLENBQUM7UUFDL0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQztJQUM3QixDQUFDO0lBTU0sR0FBRyxDQUFDLElBQVk7UUFFbkIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUc7WUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQzFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUMxQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDakQsQ0FBQztRQUVGLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBS00sSUFBSTtRQUVQLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FDakIsQ0FBQztZ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Q0FBQztRQUNuQyxDQUFDO1FBRUQsSUFBSSxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFekMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkUsQ0FBQztDQUNKO0FBN0lELHdCQTZJQyIsImZpbGUiOiJ3d3cvbGliL0ludGVycHJldGVyL1J1bm5lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkYXB0ZXIgfSBmcm9tICcuL0FkYXB0ZXInO1xyXG5pbXBvcnQgeyBQcm9jZXNzb3IgfSBmcm9tICcuL1Byb2Nlc3Nvcic7XHJcbmltcG9ydCB7IElSb2JvdCB9IGZyb20gJy4vLi4vRWxlbWVudC9Sb2JvdC9JUm9ib3QnO1xyXG5pbXBvcnQgeyBQYXJzZXIgfSBmcm9tICcuL1BhcnNlcic7XHJcblxyXG5leHBvcnQgY2xhc3MgUnVubmVyXHJcbntcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3BlZWQ6IG51bWJlciA9IDMwMDtcclxuXHJcbiAgICAvLyBTZXQgYXQgZXZlcnkgcGFyc2VcclxuICAgIHByaXZhdGUgY291bnRlcjogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSBpbnRlcnZhbDtcclxuXHJcbiAgICAvLyBTZXQgaW4gY29uc3RydWN0b3JcclxuICAgIHByaXZhdGUgYWRhcHRlcjogQWRhcHRlcjtcclxuICAgIHByaXZhdGUgcHJvY2Vzc29yOiBQcm9jZXNzb3I7XHJcbiAgICBwcml2YXRlIHBhcnNlcjogUGFyc2VyO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihyb2JvdDogSVJvYm90KVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuYWRhcHRlciA9IG5ldyBBZGFwdGVyKHJvYm90KTtcclxuICAgICAgICB0aGlzLnByb2Nlc3NvciA9IG5ldyBQcm9jZXNzb3I7XHJcbiAgICAgICAgdGhpcy5wYXJzZXIgPSBuZXcgUGFyc2VyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3RhcnQgdGhlIGV4ZWN1dGlvblxyXG4gICAgICogQHBhcmFtIGNvZGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIFJ1bihjb2RlOiBzdHJpbmcpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5TdG9wKCk7XHJcbiAgICAgICAgdGhpcy5wYXJzZXIuUGFyc2UoY29kZSk7XHJcblxyXG4gICAgICAgIHRoaXMucHJvY2Vzc29yLkNvbnRleHQgPSB7XHJcbiAgICAgICAgICAgIG1vdmU6IHRoaXMuYWRhcHRlci5tb3ZlLmJpbmQodGhpcy5hZGFwdGVyKSxcclxuICAgICAgICAgICAgdGVzdDogdGhpcy5hZGFwdGVyLnRlc3QuYmluZCh0aGlzLmFkYXB0ZXIpLFxyXG4gICAgICAgICAgICBhdHRhY2s6IHRoaXMuYWRhcHRlci5hdHRhY2suYmluZCh0aGlzLmFkYXB0ZXIpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5jb3VudGVyID0gMDtcclxuICAgICAgICB0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5FeGVjdXRlTGluZSgpLCB0aGlzLnNwZWVkKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFN0b3AgdGhlIGV4ZWN1dGlvbi5cclxuICAgICAqL1xyXG4gICAgcHVibGljIFN0b3AoKVxyXG4gICAge1xyXG4gICAgICAgIGlmKHRoaXMuaW50ZXJ2YWwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEV4ZWN1dGUgdGhlIG5leHQgbGluZVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIEV4ZWN1dGVMaW5lKCk6IHZvaWRcclxuICAgIHtcclxuICAgICAgICBpZih0aGlzLmNvdW50ZXIgPCAwICYmIHRoaXMuY291bnRlciA+PSB0aGlzLnBhcnNlci5Db2RlLmxlbmd0aClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuU3RvcCgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbGluZSA9IHRoaXMucGFyc2VyLkNvZGVbdGhpcy5jb3VudGVyKytdO1xyXG5cclxuICAgICAgICB0cnlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHN3aXRjaChsaW5lWzBdKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiTEFCRUxcIjpcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJHT1RPXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5FeGVjdXRlR290byhsaW5lKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJDQUxMXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5FeGVjdXRlQ2FsbChsaW5lKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJTRVRcIjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLkV4ZWN1dGVTZXQobGluZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2goZSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuU3RvcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEV4ZWN1dGUgYSBHT1RPIGNvbW1hbmQuXHJcbiAgICAgKiBAcGFyYW0gcGFyYW1ldGVycyBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBFeGVjdXRlR290byhwYXJhbWV0ZXJzOiBzdHJpbmdbXSk6IHZvaWRcclxuICAgIHtcclxuICAgICAgICBjb25zdCBzZXQgPSAoKSA9PiB0aGlzLmNvdW50ZXIgPSB0aGlzLnBhcnNlci5MYWJlbHMuaGFzT3duUHJvcGVydHkocGFyYW1ldGVyc1sxXSkgPyB0aGlzLnBhcnNlci5MYWJlbHNbcGFyYW1ldGVyc1sxXV0gOiAtMTtcclxuXHJcbiAgICAgICAgaWYocGFyYW1ldGVycy5sZW5ndGggPT0gMilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHNldCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmKHBhcmFtZXRlcnMubGVuZ3RoID49IDQpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gcGFyYW1ldGVycy5zbGljZSgzKS5qb2luKFwiIFwiKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmKHRoaXMucHJvY2Vzc29yLlNvbHZlKGNvbmRpdGlvbikgIT0gMCkgc2V0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgR09UT1wiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFeGVjdXRlIGEgQ0FMTCBjb21tYW5kLlxyXG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgRXhlY3V0ZUNhbGwocGFyYW1ldGVyczogc3RyaW5nW10pOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgaWYocGFyYW1ldGVycy5sZW5ndGggPCAyKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBDQUxMXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBsZXQgY2FsbCA9IHBhcmFtZXRlcnMuc2xpY2UoMSkuam9pbihcIiBcIik7XHJcblxyXG4gICAgICAgIHRoaXMucHJvY2Vzc29yLlNvbHZlKGNhbGwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRXhlY3V0ZSBhIFNFVCBjb21tYW5kLlxyXG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgRXhlY3V0ZVNldChwYXJhbWV0ZXJzOiBzdHJpbmdbXSk6IHZvaWRcclxuICAgIHtcclxuICAgICAgICBpZihwYXJhbWV0ZXJzLmxlbmd0aCA8IDMpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIFNFVFwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBjYWxsID0gcGFyYW1ldGVycy5zbGljZSgyKS5qb2luKFwiIFwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5wcm9jZXNzb3IuQ29udGV4dFtwYXJhbWV0ZXJzWzFdXSA9IHRoaXMucHJvY2Vzc29yLlNvbHZlKGNhbGwpO1xyXG4gICAgfVxyXG59Il19
