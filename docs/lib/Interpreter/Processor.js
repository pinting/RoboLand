"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Processor {
    GetInner(input) {
        if (input.indexOf("(") < 0)
            return null;
        let start = 0;
        let brackets = 0;
        for (let i = 0; i < input.length; i++) {
            switch (input[i]) {
                case "(":
                    if (brackets++ == 0)
                        start = i;
                    break;
                case ")":
                    if (brackets-- == 1)
                        return [start, i];
                    break;
            }
        }
        return null;
    }
    GetBlock(input) {
        const get = (input, a, b) => {
            let ap = input.indexOf(a);
            let bp = input.indexOf(b);
            if (ap < 0 && bp < 0)
                return input;
            if (ap < 0)
                ap = input.length;
            if (bp < 0)
                bp = input.length;
            let first = ap < bp ? ap : bp;
            let type = ap < bp ? a : b;
            return {
                left: input.substring(0, first),
                right: input.substring(first + 1, input.length),
                method: type
            };
        };
        if (!input.method) {
            input = get(input, "+", "-");
            if (!input.method)
                input = get(input, "*", "/");
        }
        return input;
    }
    ExtractBlock(block) {
        block = this.GetBlock(block);
        if (!block.method)
            return block;
        block.left = this.ExtractBlock(block.left);
        block.right = this.ExtractBlock(block.right);
        return block;
    }
    CalculateBlock(block) {
        if (!block.method) {
            const result = block.length == 0 ? 0 : parseFloat(block);
            if (result == NaN)
                throw new Error("Not a number!");
            return result;
        }
        switch (block.method) {
            case "+":
                return this.CalculateBlock(block.left) + this.CalculateBlock(block.right);
            case "-":
                return this.CalculateBlock(block.left) - this.CalculateBlock(block.right);
            case "*":
                return this.CalculateBlock(block.left) * this.CalculateBlock(block.right);
            case "/":
                return this.CalculateBlock(block.left) / this.CalculateBlock(block.right);
        }
    }
    Calculate(input) {
        let range;
        while ((range = this.GetInner(input)) != null) {
            const result = this.Calculate(input.substring(range[0] + 1, range[1]));
            input = input.substring(0, range[0]) + result + input.substring(range[1] + 1, input.length);
        }
        let block = this.ExtractBlock(input);
        return this.CalculateBlock(block);
    }
    ResolveFunctions(input) {
        const pattern = /[A-Za-z][A-Za-z0-9]*\(/;
        let start = null;
        while ((start = input.match(pattern)) != null) {
            const range = this.GetInner(input.substr(start.index)).map(p => p + start.index);
            const name = input.substring(start.index, range[0]);
            const args = [];
            const resolved = [];
            let last = range[0] + 1;
            let brackets = 0;
            for (let i = range[0] + 1; i <= range[1]; i++) {
                const c = input[i];
                if (c == "(") {
                    brackets++;
                }
                else if ((c == ")" && --brackets == -1) || (c == "," && brackets == 0)) {
                    args.push(input.substring(last, i).trim());
                    last = i + 1;
                }
            }
            args.forEach(arg => resolved.push(this.Solve(arg)));
            const result = parseFloat(this.Context[name].apply(this.Context, resolved));
            if (result == NaN)
                throw new Error("Not a number!");
            input = input.substring(0, start.index) + result + input.substring(range[1] + 1, input.length);
        }
        return input;
    }
    ResolveVariables(input) {
        const pattern = /[A-Za-z][A-Za-z0-9]*/;
        let start = null;
        while ((start = input.match(pattern)) != null) {
            const result = parseFloat(this.Context[start[0]]);
            if (result == NaN)
                throw new Error("Not a number!");
            input = input.substring(0, start.index) + result + input.substring(start.index + start[0].length, input.length);
        }
        return input;
    }
    Solve(input) {
        return this.Calculate(this.ResolveVariables(this.ResolveFunctions(input)));
    }
}
exports.Processor = Processor;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93d3cvbGliL0ludGVycHJldGVyL1Byb2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBO0lBUVksUUFBUSxDQUFDLEtBQWE7UUFFMUIsRUFBRSxDQUFBLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBRXZDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNkLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztRQUVqQixHQUFHLENBQUEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQ3BDLENBQUM7WUFDRyxNQUFNLENBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDaEIsQ0FBQztnQkFDRyxLQUFLLEdBQUc7b0JBQ0osRUFBRSxDQUFBLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7b0JBQzlCLEtBQUssQ0FBQztnQkFDVixLQUFLLEdBQUc7b0JBQ0osRUFBRSxDQUFBLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDdEMsS0FBSyxDQUFDO1lBQ2QsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFNTyxRQUFRLENBQUMsS0FBSztRQUVsQixNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQWEsRUFBRSxDQUF3QixFQUFFLENBQXdCO1lBRTFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUxQixF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QUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BILENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFPTSxLQUFLLENBQUMsS0FBYTtRQUV0QixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvRSxDQUFDO0NBQ0o7QUF0TkQsOEJBc05DIiwiZmlsZSI6Ind3dy9saWIvSW50ZXJwcmV0ZXIvUHJvY2Vzc29yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUJsb2NrIH0gZnJvbSAnLi9JQmxvY2snO1xyXG5cclxuZXhwb3J0IGNsYXNzIFByb2Nlc3NvclxyXG57XHJcbiAgICBwdWJsaWMgQ29udGV4dDogT2JqZWN0O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IHRoZSBwb3NpdGlvbiBvZiB0aGUgbmVhcmVzdCBicmFja2V0IGNsb3N1cmUuXHJcbiAgICAgKiBAcGFyYW0gaW5wdXQgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgR2V0SW5uZXIoaW5wdXQ6IHN0cmluZyk6IEFycmF5PG51bWJlcj5cclxuICAgIHtcclxuICAgICAgICBpZihpbnB1dC5pbmRleE9mKFwiKFwiKSA8IDApIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICBsZXQgc3RhcnQgPSAwO1xyXG4gICAgICAgIGxldCBicmFja2V0cyA9IDA7XHJcblxyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKylcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHN3aXRjaChpbnB1dFtpXSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIihcIjpcclxuICAgICAgICAgICAgICAgICAgICBpZihicmFja2V0cysrID09IDApIHN0YXJ0ID0gaTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCIpXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYnJhY2tldHMtLSA9PSAxKSByZXR1cm4gW3N0YXJ0LCBpXTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGUgYSBuZXcgSUJsb2NrIGZyb20gYSBzdHJpbmcgaW5wdXQgKG9yIHJldHVybiB0aGUgaW5wdXQgaXRzZWxmKS5cclxuICAgICAqIEBwYXJhbSBpbnB1dCBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBHZXRCbG9jayhpbnB1dCk6IElCbG9jayB8IHN0cmluZ1xyXG4gICAge1xyXG4gICAgICAgIGNvbnN0IGdldCA9IChpbnB1dDogc3RyaW5nLCBhOiBcIipcIiB8IFwiL1wiIHwgXCIrXCIgfCBcIi1cIiwgYjogXCIqXCIgfCBcIi9cIiB8IFwiK1wiIHwgXCItXCIpOiBJQmxvY2sgfCBzdHJpbmcgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCBhcCA9IGlucHV0LmluZGV4T2YoYSk7XHJcbiAgICAgICAgICAgIGxldCBicCA9IGlucHV0LmluZGV4T2YoYik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgIGlmKGFwIDwgMCAmJiBicCA8IDApIHJldHVybiBpbnB1dDtcclxuICAgICAgICBcclxuICAgICAgICAgICAgaWYoYXAgPCAwKSBhcCA9IGlucHV0Lmxlbmd0aDtcclxuICAgICAgICAgICAgaWYoYnAgPCAwKSBicCA9IGlucHV0Lmxlbmd0aDtcclxuICAgICAgICBcclxuICAgICAgICAgICAgbGV0IGZpcnN0ID0gYXAgPCBicCA/IGFwIDogYnA7XHJcbiAgICAgICAgICAgIGxldCB0eXBlID0gYXAgPCBicCA/IGEgOiBiO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgbGVmdDogaW5wdXQuc3Vic3RyaW5nKDAsIGZpcnN0KSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0OiBpbnB1dC5zdWJzdHJpbmcoZmlyc3QgKyAxLCBpbnB1dC5sZW5ndGgpLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiA8XCIqXCIgfCBcIi9cIiB8IFwiK1wiIHwgXCItXCI+dHlwZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoIWlucHV0Lm1ldGhvZClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGlucHV0ID0gZ2V0KGlucHV0LCBcIitcIiwgXCItXCIpO1xyXG4gICAgXHJcbiAgICAgICAgICAgIGlmKCFpbnB1dC5tZXRob2QpIGlucHV0ID0gZ2V0KGlucHV0LCBcIipcIiwgXCIvXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVHJ5IHRvIGNyZWF0ZSBhcyBtYW55IGJsb2NrcyBhcyBwb3NzaWJsZSBmcm9tIGEgYmxvY2suXHJcbiAgICAgKiBAcGFyYW0gYmxvY2sgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgRXh0cmFjdEJsb2NrKGJsb2NrKTogSUJsb2NrIHwgc3RyaW5nXHJcbiAgICB7XHJcbiAgICAgICAgYmxvY2sgPSB0aGlzLkdldEJsb2NrKGJsb2NrKTtcclxuXHJcbiAgICAgICAgaWYoIWJsb2NrLm1ldGhvZCkgcmV0dXJuIGJsb2NrO1xyXG5cclxuICAgICAgICBibG9jay5sZWZ0ID0gdGhpcy5FeHRyYWN0QmxvY2soYmxvY2subGVmdCk7XHJcbiAgICAgICAgYmxvY2sucmlnaHQgPSB0aGlzLkV4dHJhY3RCbG9jayhibG9jay5yaWdodCk7XHJcbiAgICBcclxuICAgICAgICByZXR1cm4gYmxvY2s7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxjdWxhdGUgdGhlIHJlc3VsdCBvZiBhIGJsb2NrIHRyZWUuXHJcbiAgICAgKiBAcGFyYW0gYmxvY2tcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBDYWxjdWxhdGVCbG9jayhibG9jayk6IG51bWJlclxyXG4gICAge1xyXG4gICAgICAgIGlmKCFibG9jay5tZXRob2QpIFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYmxvY2subGVuZ3RoID09IDAgPyAwIDogcGFyc2VGbG9hdChibG9jayk7XHJcblxyXG4gICAgICAgICAgICBpZihyZXN1bHQgPT0gTmFOKSB0aHJvdyBuZXcgRXJyb3IoXCJOb3QgYSBudW1iZXIhXCIpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICBzd2l0Y2goYmxvY2subWV0aG9kKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY2FzZSBcIitcIjpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLkNhbGN1bGF0ZUJsb2NrKGJsb2NrLmxlZnQpICsgdGhpcy5DYWxjdWxhdGVCbG9jayhibG9jay5yaWdodCk7XHJcbiAgICAgICAgICAgIGNhc2UgXCItXCI6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5DYWxjdWxhdGVCbG9jayhibG9jay5sZWZ0KSAtIHRoaXMuQ2FsY3VsYXRlQmxvY2soYmxvY2sucmlnaHQpO1xyXG4gICAgICAgICAgICBjYXNlIFwiKlwiOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuQ2FsY3VsYXRlQmxvY2soYmxvY2subGVmdCkgKiB0aGlzLkNhbGN1bGF0ZUJsb2NrKGJsb2NrLnJpZ2h0KTtcclxuICAgICAgICAgICAgY2FzZSBcIi9cIjpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLkNhbGN1bGF0ZUJsb2NrKGJsb2NrLmxlZnQpIC8gdGhpcy5DYWxjdWxhdGVCbG9jayhibG9jay5yaWdodCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IHRoZSByZXN1bHQgb2YgYSBzaW1wbGUgbWF0aCBwcm9ibGVtLiBZb3UgY2FuIHVzZSB0aGUgNCBiYXNpYyBvcGVyYXRvciBwbHVzIGJyYWNrZXRzLlxyXG4gICAgICogQHBhcmFtIGlucHV0IFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgQ2FsY3VsYXRlKGlucHV0OiBzdHJpbmcpOiBudW1iZXJcclxuICAgIHtcclxuICAgICAgICBsZXQgcmFuZ2U6IEFycmF5PG51bWJlcj47XHJcblxyXG4gICAgICAgIHdoaWxlKChyYW5nZSA9IHRoaXMuR2V0SW5uZXIoaW5wdXQpKSAhPSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5DYWxjdWxhdGUoaW5wdXQuc3Vic3RyaW5nKHJhbmdlWzBdICsgMSwgcmFuZ2VbMV0pKTtcclxuXHJcbiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKDAsIHJhbmdlWzBdKSArIHJlc3VsdCArIGlucHV0LnN1YnN0cmluZyhyYW5nZVsxXSArIDEsIGlucHV0Lmxlbmd0aCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgYmxvY2sgPSB0aGlzLkV4dHJhY3RCbG9jayhpbnB1dCk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLkNhbGN1bGF0ZUJsb2NrKGJsb2NrKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlc29sdmUgZnVuY3Rpb25zIGluIGEgc3RyaW5nLlxyXG4gICAgICogQHBhcmFtIGlucHV0IFxyXG4gICAgICogQHBhcmFtIGNvbnRleHQgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgUmVzb2x2ZUZ1bmN0aW9ucyhpbnB1dDogc3RyaW5nKTogc3RyaW5nXHJcbiAgICB7XHJcbiAgICAgICAgY29uc3QgcGF0dGVybiA9IC9bQS1aYS16XVtBLVphLXowLTldKlxcKC87XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHN0YXJ0OiBSZWdFeHBNYXRjaEFycmF5ID0gbnVsbDtcclxuXHJcbiAgICAgICAgd2hpbGUoKHN0YXJ0ID0gaW5wdXQubWF0Y2gocGF0dGVybikpICE9IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjb25zdCByYW5nZSA9IHRoaXMuR2V0SW5uZXIoaW5wdXQuc3Vic3RyKHN0YXJ0LmluZGV4KSkubWFwKHAgPT4gcCArIHN0YXJ0LmluZGV4KTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGlucHV0LnN1YnN0cmluZyhzdGFydC5pbmRleCwgcmFuZ2VbMF0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IFtdO1xyXG4gICAgXHJcbiAgICAgICAgICAgIGxldCBsYXN0ID0gcmFuZ2VbMF0gKyAxO1xyXG4gICAgICAgICAgICBsZXQgYnJhY2tldHMgPSAwO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gcmFuZ2VbMF0gKyAxOyBpIDw9IHJhbmdlWzFdOyBpKyspXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBpbnB1dFtpXTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZihjID09IFwiKFwiKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGJyYWNrZXRzKys7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmKChjID09IFwiKVwiICYmIC0tYnJhY2tldHMgPT0gLTEpIHx8IChjID09IFwiLFwiICYmIGJyYWNrZXRzID09IDApKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChpbnB1dC5zdWJzdHJpbmcobGFzdCwgaSkudHJpbSgpKTtcclxuICAgICAgICAgICAgICAgICAgICBsYXN0ID0gaSArIDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIFJlc29sdmUgYXJndW1lbnRzXHJcbiAgICAgICAgICAgIGFyZ3MuZm9yRWFjaChhcmcgPT4gcmVzb2x2ZWQucHVzaCh0aGlzLlNvbHZlKGFyZykpKTtcclxuXHJcbiAgICAgICAgICAgIC8vIEdldCByZXN1bHRcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VGbG9hdCh0aGlzLkNvbnRleHRbbmFtZV0uYXBwbHkodGhpcy5Db250ZXh0LCByZXNvbHZlZCkpO1xyXG5cclxuICAgICAgICAgICAgaWYocmVzdWx0ID09IE5hTikgdGhyb3cgbmV3IEVycm9yKFwiTm90IGEgbnVtYmVyIVwiKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFJlcGxhY2UgZnVuY3Rpb24gd2l0aCB0aGUgcmVzdWx0XHJcbiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKDAsIHN0YXJ0LmluZGV4KSArIHJlc3VsdCArIGlucHV0LnN1YnN0cmluZyhyYW5nZVsxXSArIDEsIGlucHV0Lmxlbmd0aCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXNvbHZlIHZhcmlhYmxlcyBpbiBhIHN0cmluZy5cclxuICAgICAqIEBwYXJhbSBpbnB1dCBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBSZXNvbHZlVmFyaWFibGVzKGlucHV0OiBzdHJpbmcpOiBzdHJpbmdcclxuICAgIHtcclxuICAgICAgICBjb25zdCBwYXR0ZXJuID0gL1tBLVphLXpdW0EtWmEtejAtOV0qLztcclxuXHJcbiAgICAgICAgbGV0IHN0YXJ0OiBSZWdFeHBNYXRjaEFycmF5ID0gbnVsbDtcclxuICAgICAgICBcclxuICAgICAgICB3aGlsZSgoc3RhcnQgPSBpbnB1dC5tYXRjaChwYXR0ZXJuKSkgIT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHBhcnNlRmxvYXQodGhpcy5Db250ZXh0W3N0YXJ0WzBdXSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZihyZXN1bHQgPT0gTmFOKSB0aHJvdyBuZXcgRXJyb3IoXCJOb3QgYSBudW1iZXIhXCIpO1xyXG5cclxuICAgICAgICAgICAgaW5wdXQgPSBpbnB1dC5zdWJzdHJpbmcoMCwgc3RhcnQuaW5kZXgpICsgcmVzdWx0ICsgaW5wdXQuc3Vic3RyaW5nKHN0YXJ0LmluZGV4ICsgc3RhcnRbMF0ubGVuZ3RoLCBpbnB1dC5sZW5ndGgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVzb2x2ZSBmdW5jdGlvbnMgYW5kIHZhcmlhYmxlcyB0aGVuIGNhbGN1bGF0ZSB0aGUgbWF0aCBwcm9ibGVtLlxyXG4gICAgICogQHBhcmFtIGlucHV0XHJcbiAgICAgKiBAcGFyYW0gY29udGV4dCBKYXZhU2NyaXB0IE9iamVjdC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIFNvbHZlKGlucHV0OiBzdHJpbmcpOiBudW1iZXJcclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5DYWxjdWxhdGUodGhpcy5SZXNvbHZlVmFyaWFibGVzKHRoaXMuUmVzb2x2ZUZ1bmN0aW9ucyhpbnB1dCkpKTtcclxuICAgIH1cclxufSJdfQ==
